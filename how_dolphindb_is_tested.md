# 分布式时序数据库DolphinDB是如何被测试的？

数据库是仅次于操作系统的复杂软件系统。分布式数据库的复杂度比起单机数据库又有成倍的增加。如何通过测试来保证如此复杂的软件系统的正确性和稳定性，一直是技术圈的神秘话题。DolphinDB作为一个一站式的分布式时序数据库，集数据库、编程语言和分布式计算于一体，涵盖了存储、流数据、大数据分析和机器学习四大引擎，内置了1000多个函数，分布式系统又支持高可用和强一致性，系统的复杂性可见一斑。本教程与大家分享DolphinDB团队的测试工具、流程和方法。

- [1. 软件设计和测试工具](1-软件设计和测试工具)
- [2. 功能测试](#2-功能测试)
- [3. 稳定性测试](#3-稳定性测试)
- [4. 异常测试](#4-异常测试)
    - [4.1 OOM测试](#41-OOM测试)
    - [4.2 I/O错误测试](#42-IO错误测试)
    - [4.3 节点崩溃测试](#43-节点崩溃测试)
- [5. 发布测试](#5-发布测试)
    - [5.1 回归测试](#51-回归测试)
    - [5.2 兼容性测试](#52-兼容性测试)
    - [5.3 性能测试](#53-性能测试)
- [6. bug的处理](#6-bug的处理)
- [7. 覆盖率](#7-覆盖率)
- [8. 展望](#8-展望)

## 1. 软件设计和测试工具

DolphinDB作为一个一站式的高性能分布式时序数据库，功能众多，十分复杂。但通过函数化的解耦设计，整个系统的复杂度大大降低。无论是分布式还是本地功能，内部的系统功能还是面向最终用户的外部功能，DolphinDB坚持用函数来表达。所有函数均可以通过内置的脚本语言来调用。如果调用跨节点（集群内各节点之间的调用或独立的DolphinDB节点之间的调用），均可以远程过程调用（RPC）。

函数化的设计不仅降低了系统的整体复杂度，也使整个系统的可测试性大大增强。单元测试通过测试每一个函数即可完成。集成测试可以通过控制语句调用系列函数来实现。分布式测试可以通过远程过程调用一系列函数来完成。

DolphinDB内置的脚本语言不仅可以让用户快速进行二次开发，也可以让测试人员高效的编写自动化测试case。DolphinDB内置的单元测试框架，具备编写用例、执行用例和输出测试报告的能力。和其他语言的测试框架类似，DolphinDB的测试框架有声明测试用例和assert的功能。DolphinDB server的测试全部使用其内置的脚本语言来完成。

## 2. 功能测试

功能测试可以分为单元测试和集成测试，主要是针对DolphinDB内置函数、SQL语句及分布式查询和计算的测试，重点是在功能的用户友好性、易用性、性能和正确性上。DolphinDB的大部分功能都是通过函数接口的方式提供给用户，因此我们采用自动化的方式，通过测试框架，编写测试脚本，验证测试结果是否正确。

DolphinDB内置的单元测试框架，具备编写用例、执行用例和输出测试报告的能力。和其他语言的测试框架类似，DolphinDB的测试框架有声明测试用例和assert。以下是DolphinDB中avg的测试用例。

```
@testing:case="function_avg"
assert 1, eqObj(avg 1 2 3, 2.000,3)
assert 2, eqObj(avg 2 3.5 4, 3.167, 3)
assert 3, eqObj(avg true false, 0.5, 1)
x=1 NULL NULL NULL 3;
assert 4, eqObj(avg x, 2.0);
```

DolphinDB还有异常测试用例，用于验证代码是否按照期望抛出异常。DolphinDB具有两类异常：syntaxError和exception。DolphinDB运行代码的过程是，先对代码进行语法解析，如果发现变量、函数未定义等错误时，将报告syntaxError，不会执行代码；解析成功后，才会逐行执行代码，执行代码中出现的问题就是exception。

下面是syntaxError的用例，2019.00.28是一个非法日期，DolphinDB无法解析该日期，抛出了syntaxError的错误。

```
@testing:case="test_syntaxError", syntaxError=1
a=2019.00.28
```

下面是exception的用例，代码中没有语法错误，但是向量相加要求长度必须相等，因此执行代码时会抛出异常，属于exception。

```
@testing:case="test_function_add_size_incompatible",exception=1
a=[1, 2, 3]
b=[1, 2]
a+b
```

DolphinDB本身提供了Java，Python等编程语言的接口，那为什么还要使用DolphinDB自身的脚本语言来编写测试用例呢？原因有三：（一）便于定位问题。使用Java或Python来编写DolphinDB的测试用例，会增加测试的复杂度，如果发现问题，难以判断是api还是server端的bug。（二）测试用例执行效率高。直接在server端执行用例，测试数据集无需传输到客户端，减少了执行耗时。（三）DolphinDB的混合范式编程让测试用例的代码非常简洁。测试时需要涵盖所有数据类型，通过DolphinDB的一些高阶函数，可以写出非常简洁的测试用例。下面是sum函数覆盖所有数值类型的测试用例。通过each函数，将sum函数应用到各个类型的数组，并验证结果的正确性。

```
@testing:case="function_sum"
def f(dtype){
	vec = dtype(9 -1 23 NULL NULL NULL 1 -10 13 -2)
	expected = double(33)
	return eqObj(double(sum(vec)), expected)
}
types=[char, short, int,long, float, double]
assert 1, each(f, types)
```

至今（2020.12），我们最新的branch已积累了24478个功能测试用例，平均每个用例包含5-10个assert，共计1156个测试文件，总文件大小近6MB。在日常测试中，我们会每日定时构建两次功能测试，这是非常有效的产品质量保障，能够保证持续开发过程中不影响已有功能的正确性。

## 3. 稳定性测试

稳定性测试旨在验证DolphinDB在正常情况下（磁盘空间和内存都足够）的能否正确响应。我们在多台企业级服务器上部署了多个DolphinDB集群，模拟多用户并发读写分布式数据库，持续监控DolphinDB运行的情况。稳定性测试关注的指标包括节点是否存活、能否持续读写数据、读写性能是否下降、是否存在内存泄漏等。

从目前的测试结果来看，在多用户并发读写的情况下，DolphinDB能够实现7*24小时不停机提供服务。

## 4. 异常测试

系统的健壮性体现在有干扰或输入数据不合理的情况下，仍然能够进行适当的工作。我们对DolphinDB进行异常测试，主要是验证DolphinDB在出现问题时能否正常处理。目前我们对DolphinDB进行了三方面的异常测试：OOM测试、I/O错误测试和节点崩溃测试。

### 4.1 OOM测试

OOM测试是验证DolphinDB在内存不足时是否做出合理的响应。OOM测试主要是通过模拟内存不足的情况来测试。DolphinDB从1.10版本开始，采用tcmalloc管理和分配内存，OOM引起的问题明显减少了很多。

### 4.2 I/O错误测试

I/O错误测试主要是验证DolphinDB是否对错误的I/O操作做出合理的处理。I/O错误可能是磁盘空间不足、文件损坏和网络中断等原因造成的。

磁盘空间不足的测试是使用虚拟机来测试，在创建虚拟机时指定较小的磁盘空间，再在虚拟机中部署DolphinDB，并启动数据写入。当磁盘被占满后，数据写入会中止，DolphinDB的日志会给出WARNING或者ERROR。

网络中断测试主要是验证DolphinDB集群运行过程中网络中断时的表现。测试的步骤是，部署一个多节点集群，在A节点上提交读写任务，中断B节点的网络，观察A节点上的读写任务能否继续进行。一段时间后，恢复B节点的网络，观察在B节点上能否提交读写任务。

### 4.3 节点崩溃测试

节点崩溃测试主要是验证DolphinDB集群在部分节点崩溃时是否做出合理的反应。我们测试了两种导致节点崩溃的情况，一种是操作系统kill节点进程，另一种是服务器断电导致节点不可用。

第一种情况的测试方案是，使用API向测试集群提交读写任务，启动一个独立的DolphinDB节点作为辅助节点来执行shell命令kill和start测试集群任一节点的进程，这一过程通过编写程序自动执行。使用API提交读写任务的原因是，API支持自动切换连接的节点，即使当前连接的节点关闭了，可以自动切换连接到其他节点，并把当前任务提交到新的节点，这样能够测试某一节点的崩溃是否对整个集群的读写功能造成影响。启动独立的DolphinDB节点作为辅助节点的原因是，DolphinDB提供的shell函数可以执行操作系统的命令，可以用来做一些关闭和启动进程的操作，另一个原因是，关闭和启动进程后需要验证节点是否符合预期地下线和上线，DolphinDB的xdb函数可以用于远程节点的通信，非常符合这个场景。从测试结果来看，某一节点被kill之后，集群仍然能够提供正常读写，节点重启后，该节点的数据也能恢复。

第二种情况是通过模拟断电来测试，使用API向测试集群提交读写任务，切断某一节点所在服务器的电源，观察API能否切换到其他存活的节点提交读写任务，电源恢复后，手动启动节点，观察该节点能否恢复正常。测试结果显示，某些节点因为断电导致崩溃，不会影响集群的其他节点。若DolphinDB配置了dataSync=1，断电节点重启后，数据仍然能否恢复正常；若没有配置dataSync，断电节点重启后，有可能会出现数据丢失或损坏。

## 5. 发布测试

DolphinDB目前有两个版本：稳定版和最新版。每个版本针对不同的操作系统分为linux和windows版本。linux版本包含普通版本、JIT版本和ABI=1版本，windows版本包含普通版本和JIT版本，共包含5个版本。发布测试需要对每个版本进行测试，保证发布版本正确可用。DolphinDB使用c++语言开发。上面提到的5个不同的版本共用同一个代码分支，通过条件编译来区别不同版本。为减少发布错误，提升发布效率，我们引入了jenkins，自动化各个版本的编译、链接、打包和测试。

### 5.1 回归测试

每当DolphinDB发布新版本之前，我们都会对新版本进行回归测试。回归测试采用自动化的方式执行所有功能测试用例，每个版本耗时将近4小时。如果是大版本发布，比如1.1.0, 1.2.0等，我们会提前一到两周进行长期测试和异常测试。

### 5.2 兼容性测试

数据库是客户最重要的IT资产之一。确保数据和代码的在不同版本之间的平滑升级是一个商业数据库产品对客户最大的承若之一。DolphinDB是向前兼容的，即新版本兼容老版本。大版本发布前，我们会对DolphinDB进行版本的兼容性测试。DolphinDB兼容性测试的内容包括：分布式数据库、用户和权限、定时作业（scheduled job）、持久化的流表，函数以及API。

DolphinDB的API和server之间的藕合不是很强，大部分时候server升级，API不需要升级。DolphinDB内置1000多个函数，函数名称的修改和参数的调整难以避免。修改函数名称时，DolphinDB通过增加函数别名的方法来保持兼容性。需要修改函数参数时，DolphinDB确保不减少参数个数，不修改参数名称，不调整参数顺序，只增加可选参数，以此来确保兼容性。

我们也鼓励用户使用DolphinDB内置的测试框架对二次开发的功能编写自动化测试case。用户升级之前，也可以自行做兼容性测试。

### 5.3 性能测试

大版本发布前，我们会对DolphinDB进行性能测试。DolphinDB性能测试的内容包括：千万级数据量下常用的查询效率、单线程或多线程写入效率。DolphinDB还在不断地提升性能，每个大版本基本上都有性能方面的改进。

我们建立了性能基准。新版本的性能测试结果会跟基准进行比较，如果性能出现下降，开发人员会进行调查。性能基准测试可以避免在增加功能，bug修复等过程中无意导致系统性能降低的情况。

## 6. bug的处理

当用户反馈bug，我们会第一时间安排复现问题，并报告开发人员。等待bug修复后，我们会将复现该bug的代码加入到DolphinDB的测试用例。多年来，用户向我们反馈的bug都包含在用例中，对这些用例进行回归测试能够保证以前已修复的bug不会重新引入到DolphinDB未来版本中。

## 7. 覆盖率

代码覆盖率是反映测试用例对被测软件覆盖程度的重要指标。目前我们使用BullseyeCoverage来评估代码中的覆盖率。DolphinDB 1.20.9版本功能测试的条件覆盖率为80%。

## 8. 展望

DolphinDB是一个非常复杂的系统，并且在不断完善和发展过程中，我们会持续进行测试，维护和提高产品质量。
